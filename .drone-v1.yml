---
kind: pipeline
type: kubernetes
name: build

steps:
- name: build-project
  image: quay.io/ukhomeofficedigital/openjdk11:v11.0.5_10
  commands:
  - ./gradlew build
  when:
    event:
      - push
      - pull_request

- name: sonar-scanner
  image: quay.io/ukhomeofficedigital/sonar-scanner:v3.0.3
  when:
    event:
      - push
      - pull_request

- name: build-and-push-docker-image
  image: plugins/docker
  settings:
    registry: quay.io
    repo: quay.io/ukhomeofficedigital/hocs-templates
    tags:
      - build-${DRONE_BUILD_NUMBER}
      - ${DRONE_COMMIT_SHA}
      - branch-${DRONE_COMMIT_BRANCH/\//_}
  environment:
    DOCKER_PASSWORD:
      from_secret: QUAY_ROBOT_PASSWORD
    DOCKER_USERNAME: ukhomeofficedigital+hocs_quay_robot
  when:
    branch:
      - epic/*
      - hotfix/*
      - master
    event:
      - push

- name: build-and-push-docker-image-latest
  image: plugins/docker
  settings:
    registry: quay.io
    repo: quay.io/ukhomeofficedigital/hocs-templates
    tags:
      - master
  environment:
    DOCKER_PASSWORD:
      from_secret: QUAY_ROBOT_PASSWORD
    DOCKER_USERNAME: ukhomeofficedigital+hocs_quay_robot
  when:
    branch:
      - master
    event:
      - push

trigger:
  event:
    - push
    - pull_request

---

kind: pipeline
type: kubernetes
name: deploy
depends_on:
  - build

steps:
- name: clone-kube-project
  image: plugins/git
  commands:
    - git clone https://github.com/UKHomeOffice/kube-hocs-templates.git
  when:
    event:
      - push
      - promote

- name: deploy-to-cs-dev-from-build-number
  image: quay.io/ukhomeofficedigital/kd:v1.16.0
  commands:
    - cd kube-hocs-templates
    - ./deploy.sh
  environment:
    ENVIRONMENT: cs-dev
    HOCS_TEMPLATES_CS_DEV:
      from_secret: hocs_templates_cs_dev
    KUBE_SERVER: https://kube-api-notprod.notprod.acp.homeoffice.gov.uk
    VERSION: build-${DRONE_BUILD_NUMBER}
  when:
    branch:
      - master
    event:
      - push
  depends_on:
    - clone-kube-project

- name: deploy-to-wcs-dev-from-build-number
  image: quay.io/ukhomeofficedigital/kd:v1.16.0
  commands:
    - cd kube-hocs-templates
    - ./deploy.sh
  environment:
    ENVIRONMENT: wcs-dev
    HOCS_TEMPLATES_WCS_DEV:
      from_secret: hocs_templates_wcs_dev
    KUBE_SERVER: https://kube-api-notprod.notprod.acp.homeoffice.gov.uk
    VERSION: build-${DRONE_BUILD_NUMBER}
  when:
    branch:
      - master
    event:
      - push
  depends_on:
    - clone-kube-project

- name: docker-semver-tag
  image: quay.io/ukhomeofficedigital/hocs-version-bot:latest
  commands:
    - >
      /app/hocs-deploy
      --dockerRepository=quay.io/ukhomeofficedigital
      --environment=qa
      --registryPassword=$${DOCKER_PASSWORD}
      --registryUser=ukhomeofficedigital+hocs_quay_robot
      --service=${SERVICE}
      --serviceGitToken=$${GITHUB_TOKEN}
      --sourceBuild=$${IMAGE_VERSION}
      --version=$${SEMVER}
      --versionRepo="https://gitlab.digital.homeoffice.gov.uk/hocs/hocs-versions.git"
      --versionRepoServiceToken=$${GITLAB_TOKEN}
  environment:
    DOCKER_PASSWORD:
      from_secret: QUAY_ROBOT_PASSWORD
    GITLAB_TOKEN:
      from_secret: GITLAB_TOKEN
    GITHUB_TOKEN:
      from_secret: GITHUB_TOKEN
  when:
    event:
      - promote
    target:
      - release

- name: deploy-to-cs-qa
  image: quay.io/ukhomeofficedigital/kd:v1.16.0
  commands:
    - source version.txt
    - echo $VERSION
    - cd kube-hocs-templates
    - ./deploy.sh
  environment:
    ENVIRONMENT: cs-qa
    HOCS_TEMPLATES_CS_QA:
      from_secret: hocs_templates_cs_qa
    HOCS_TEMPLATES_WCS_QA:
      from_secret: hocs_templates_wcs_qa
    KUBE_SERVER: https://kube-api-notprod.notprod.acp.homeoffice.gov.uk
  when:
    event:
      - promote
    target:
      - release
  depends_on:
    - clone-kube-project
    - docker-semver-tag

- name: deploy-to-wcs-qa
  image: quay.io/ukhomeofficedigital/kd:v1.16.0
  commands:
    - source version.txt
    - echo $VERSION
    - cd kube-hocs-templates
    - ./deploy.sh
  environment:
    ENVIRONMENT: wcs-qa
    HOCS_TEMPLATES_CS_QA:
      from_secret: hocs_templates_cs_qa
    HOCS_TEMPLATES_WCS_QA:
      from_secret: hocs_templates_wcs_qa
    KUBE_SERVER: https://kube-api-notprod.notprod.acp.homeoffice.gov.uk
  when:
    event:
      - promote
    target:
      - release
  depends_on:
    - clone-kube-project
    - docker-semver-tag

- name: deploy-to-notprod
  image: quay.io/ukhomeofficedigital/kd:v1.16.0
  commands:
    - cd kube-hocs-templates
    - ./deploy.sh
  environment:
    ENVIRONMENT: ${DRONE_DEPLOY_TO}
    HOCS_TEMPLATES_CS_DEV:
      from_secret: hocs_templates_cs_dev
    HOCS_TEMPLATES_WCS_DEV:
      from_secret: hocs_templates_wcs_dev
    HOCS_TEMPLATES_CS_DEMO:
      from_secret: hocs_templates_cs_demo
    HOCS_TEMPLATES_WCS_DEMO:
      from_secret: hocs_templates_wcs_demo
    HOCS_TEMPLATES_HOCS_QAX:
      from_secret: hocs_templates_qax
    KUBE_SERVER: https://kube-api-notprod.notprod.acp.homeoffice.gov.uk
  when:
    event:
      - promote
    target:
      exclude:
        - release
        - cs-prod
        - wcs-prod
  depends_on:
    - clone-kube-project

- name: deploy-to-prod
  image: quay.io/ukhomeofficedigital/kd:v1.16.0
  commands:
    - cd kube-hocs-templates
    - ./deploy.sh
  environment:
    ENVIRONMENT: ${DRONE_DEPLOY_TO}
    HOCS_TEMPLATES_CS_PROD:
      from_secret: hocs_templates_cs_prod
    HOCS_TEMPLATES_WCS_PROD:
      from_secret: hocs_templates_wcs_prod
    KUBE_SERVER: https://kube-api-prod.prod.acp.homeoffice.gov.uk
  when:
    event:
      - promote
    target:
      - cs-prod
      - wcs-prod
  depends_on:
    - clone-kube-project

trigger: 
  event: 
    - promote

trigger: 
  event:
    - push
  branch:
    - master

...
